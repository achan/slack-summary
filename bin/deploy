#!/usr/bin/env bash
set -e

cd "$(dirname "$0")/.."

LOCK_DIR="tmp/deploy.lock"
LOCK_TIMEOUT=300 # 5 minutes

if ! mkdir "$LOCK_DIR" 2>/dev/null; then
  if [ -d "$LOCK_DIR" ]; then
    lock_age=$(( $(date +%s) - $(stat -f %m "$LOCK_DIR") ))
    if [ "$lock_age" -gt "$LOCK_TIMEOUT" ]; then
      echo "$(date '+%Y-%m-%d %H:%M:%S') Removing stale deploy lock (${lock_age}s old)"
      rmdir "$LOCK_DIR" 2>/dev/null || true
      mkdir "$LOCK_DIR"
    else
      echo "$(date '+%Y-%m-%d %H:%M:%S') Deploy already in progress (${lock_age}s), skipping"
      exit 0
    fi
  fi
fi
trap 'rmdir "$LOCK_DIR" 2>/dev/null' EXIT

echo "$(date '+%Y-%m-%d %H:%M:%S') Starting deploy..."

echo "$(date '+%Y-%m-%d %H:%M:%S') Pulling latest code..."
git pull origin main

echo "$(date '+%Y-%m-%d %H:%M:%S') Installing dependencies..."
bundle install --jobs 4

echo "$(date '+%Y-%m-%d %H:%M:%S') Precompiling assets..."
RAILS_ENV=production bin/rails assets:precompile

echo "$(date '+%Y-%m-%d %H:%M:%S') Running migrations..."
RAILS_ENV=production bin/rails db:migrate

echo "$(date '+%Y-%m-%d %H:%M:%S') Requesting server restart..."
PROD_PIDFILE="tmp/pids/prod.pid"
if [ -f "$PROD_PIDFILE" ]; then
  PROD_PID=$(cat "$PROD_PIDFILE")
  if kill -0 "$PROD_PID" 2>/dev/null; then
    kill -USR1 "$PROD_PID"
    echo "$(date '+%Y-%m-%d %H:%M:%S') Sent SIGUSR1 to bin/prod (PID $PROD_PID)"
  else
    echo "$(date '+%Y-%m-%d %H:%M:%S') bin/prod PID $PROD_PID not running"
  fi
else
  echo "$(date '+%Y-%m-%d %H:%M:%S') No prod.pid found, cannot signal restart"
fi

echo "$(date '+%Y-%m-%d %H:%M:%S') Deploy complete."
