#!/usr/bin/env bash
set -e

cd "$(dirname "$0")/.."

LOCK_DIR="tmp/deploy.lock"
LOCK_TIMEOUT=300 # 5 minutes

if ! mkdir "$LOCK_DIR" 2>/dev/null; then
  if [ -d "$LOCK_DIR" ]; then
    lock_age=$(( $(date +%s) - $(stat -f %m "$LOCK_DIR") ))
    if [ "$lock_age" -gt "$LOCK_TIMEOUT" ]; then
      echo "$(date '+%Y-%m-%d %H:%M:%S') Removing stale deploy lock (${lock_age}s old)"
      rmdir "$LOCK_DIR" 2>/dev/null || true
      mkdir "$LOCK_DIR"
    else
      echo "$(date '+%Y-%m-%d %H:%M:%S') Deploy already in progress (${lock_age}s), skipping"
      exit 0
    fi
  fi
fi
trap 'rmdir "$LOCK_DIR" 2>/dev/null' EXIT

echo "$(date '+%Y-%m-%d %H:%M:%S') Starting deploy..."

echo "$(date '+%Y-%m-%d %H:%M:%S') Pulling latest code..."
git pull origin main

echo "$(date '+%Y-%m-%d %H:%M:%S') Installing dependencies..."
bundle install --jobs 4

echo "$(date '+%Y-%m-%d %H:%M:%S') Precompiling assets..."
RAILS_ENV=production bin/rails assets:precompile

echo "$(date '+%Y-%m-%d %H:%M:%S') Running migrations..."
RAILS_ENV=production bin/rails db:migrate

echo "$(date '+%Y-%m-%d %H:%M:%S') Restarting server..."
PIDFILE="tmp/pids/server.pid"
if [ -f "$PIDFILE" ]; then
  PID=$(cat "$PIDFILE")
  if kill -0 "$PID" 2>/dev/null; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') Sending SIGTERM to PID $PID..."
    kill "$PID" 2>/dev/null || true

    # Wait for process to actually exit (up to 30s)
    elapsed=0
    while kill -0 "$PID" 2>/dev/null && [ "$elapsed" -lt 30 ]; do
      sleep 1
      elapsed=$((elapsed + 1))
    done

    if kill -0 "$PID" 2>/dev/null; then
      echo "$(date '+%Y-%m-%d %H:%M:%S') Server still alive after ${elapsed}s, sending SIGKILL..."
      kill -9 "$PID" 2>/dev/null || true
      sleep 1
    else
      echo "$(date '+%Y-%m-%d %H:%M:%S') Server stopped after ${elapsed}s"
    fi
  else
    echo "$(date '+%Y-%m-%d %H:%M:%S') PID $PID not running, removing stale pidfile"
  fi
  rm -f "$PIDFILE"
else
  echo "$(date '+%Y-%m-%d %H:%M:%S') No pidfile found, touching restart.txt"
  touch tmp/restart.txt
fi

echo "$(date '+%Y-%m-%d %H:%M:%S') Deploy complete."
